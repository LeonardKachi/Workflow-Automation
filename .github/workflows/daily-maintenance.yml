name: Daily Maintenance

on:
  schedule:
    - cron: '17 4 * * 1,3,5'
    - cron: '42 20 * * 2,4'
    - cron: '23 11 * * 6'
  
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even on weekend?'
        required: false
        default: 'no'
        type: choice
        options:
          - yes
          - no

permissions:
  contents: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pandas numpy matplotlib
          
      - name: Configure Git
        run: |
          git config --global user.name "Kachi"
          git config --global user.email "Kachi.Henry.Leo@gmail.com"
          git config --global pull.rebase false

      - name: Determine Day Type
        id: day_info
        run: |
          DAY=$(date +%A)
          HOUR=$(date +%H)
          FORCE_RUN="${{ github.event.inputs.force_run }}"
          
          echo "day_name=$DAY" >> $GITHUB_ENV
          echo "hour=$HOUR" >> $GITHUB_ENV
          
          # Check if it's Sunday and not forced
          if [ "$DAY" = "Sunday" ] && [ "$FORCE_RUN" != "yes" ]; then
            echo "should_run=false" >> $GITHUB_ENV
            echo "activity_level=skipped" >> $GITHUB_ENV
            echo "skip_tests=true" >> $GITHUB_ENV
            echo "is_sunday=true" >> $GITHUB_ENV
            echo "ðŸŒž Sunday detected - workflow will be skipped"
          else
            echo "should_run=true" >> $GITHUB_ENV
            echo "is_sunday=false" >> $GITHUB_ENV
            
            if [ "$DAY" = "Sunday" ] && [ "$FORCE_RUN" = "yes" ]; then
              echo "activity_level=forced" >> $GITHUB_ENV
              echo "skip_tests=false" >> $GITHUB_ENV
              echo "âš ï¸ Sunday but force run enabled"
            elif [ "$DAY" = "Saturday" ]; then
              echo "activity_level=light" >> $GITHUB_ENV
              echo "skip_tests=true" >> $GITHUB_ENV
            elif [ "$HOUR" -lt 12 ]; then
              echo "activity_level=normal" >> $GITHUB_ENV
              echo "skip_tests=false" >> $GITHUB_ENV
            else
              echo "activity_level=evening" >> $GITHUB_ENV
              echo "skip_tests=false" >> $GITHUB_ENV
            fi
          fi
          
          # Also set step outputs for backward compatibility
          echo "day_name=$DAY" >> $GITHUB_OUTPUT
          echo "hour=$HOUR" >> $GITHUB_OUTPUT
          echo "should_run=${{ env.should_run }}" >> $GITHUB_OUTPUT
          echo "activity_level=${{ env.activity_level }}" >> $GITHUB_OUTPUT
          echo "skip_tests=${{ env.skip_tests }}" >> $GITHUB_OUTPUT
          
      - name: Early Exit if Sunday
        if: env.is_sunday == 'true'
        run: |
          echo "## Sunday Maintenance Skipped" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ env.day_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Sunday - rest day (use force_run=yes to override)" >> $GITHUB_STEP_SUMMARY
          exit 0
          
      - name: Create necessary directories
        if: env.should_run == 'true'
        run: |
          echo "Creating directories..."
          mkdir -p test_results
          mkdir -p scripts
          mkdir -p docs
          echo "âœ… Directories created"
          
      - name: Create placeholder scripts
        if: env.should_run == 'true'
        run: |
          echo "Creating placeholder scripts..."
          
          # Create run_tests.py
          cat > scripts/run_tests.py << 'EOF'
          #!/usr/bin/env python3
          import json
          from datetime import datetime
          
          print("Running tests...")
          result = {
              "timestamp": datetime.now().isoformat(),
              "tests_run": 5,
              "passed": 5,
              "failed": 0,
              "status": "success"
          }
          
          with open("test_results/latest.json", "w") as f:
              json.dump(result, f, indent=2)
          
          print("âœ… All tests passed")
          EOF
          
          # Create process_data.py
          cat > scripts/process_data.py << 'EOF'
          #!/usr/bin/env python3
          import json
          from datetime import datetime
          import os
          
          print("Processing data...")
          
          day = os.environ.get('day_name', 'Unknown')
          level = os.environ.get('activity_level', 'normal')
          
          data = {
              "timestamp": datetime.now().isoformat(),
              "processed": True,
              "records": 42,
              "day": day,
              "activity_level": level
          }
          
          with open("processed_data.json", "w") as f:
              json.dump(data, f, indent=2)
          
          with open("daily_update.md", "w") as f:
              f.write(f"# {day} Update - {datetime.now().strftime('%Y-%m-%d')}\\n\\n")
              f.write("## Activity Summary\\n")
              f.write(f"- Data processed: {datetime.now().strftime('%H:%M')}\\n")
              f.write(f"- Day type: {level}\\n")
              f.write(f"- Records processed: {data['records']}\\n")
          
          print(f"âœ… Data processed")
          EOF
          
          # Create update_docs.py
          cat > scripts/update_docs.py << 'EOF'
          #!/usr/bin/env python3
          from datetime import datetime
          import os
          
          print("Updating documentation...")
          
          os.makedirs("docs", exist_ok=True)
          
          level = os.environ.get('activity_level', 'normal')
          
          with open("docs/analytics.md", "a") as f:
              f.write(f"- Updated at {datetime.now().strftime('%Y-%m-%d %H:%M')} ({level})\\n")
          
          print("âœ… Documentation updated")
          EOF
          
          chmod +x scripts/*.py
          echo "âœ… Scripts created"
          
      - name: Run Automated Tests
        if: env.should_run == 'true' && env.skip_tests == 'false'
        continue-on-error: true
        id: tests
        run: |
          echo "Running test suite..."
          python scripts/run_tests.py
          echo "test_exit_code=$?" >> $GITHUB_ENV
          
      - name: Process Data & Generate Analytics
        if: env.should_run == 'true'
        id: data-process
        run: |
          echo "Processing data and generating analytics..."
          python scripts/process_data.py
          echo "data_processed=true" >> $GITHUB_ENV
          echo "âœ… Data processing complete"
          
      - name: Update Documentation
        if: env.should_run == 'true'
        id: docs
        run: |
          echo "Updating documentation..."
          
          # Create varied commit messages
          MESSAGES=(
            "docs: Update project files - $(date '+%Y-%m-%d')"
            "chore: Maintenance updates for $(date '+%A')"
            "update: Daily sync and data processing"
            "fix: Minor updates and cleanup"
            "feat: Add daily analytics report"
          )
          
          RANDOM_MSG=${MESSAGES[$RANDOM % ${#MESSAGES[@]}]}
          echo "commit_message=$RANDOM_MSG" >> $GITHUB_ENV
          
          python scripts/update_docs.py
          
          # Update README
          echo "" >> README.md
          echo "**Last updated:** $(date '+%A, %B %d, %Y at %H:%M UTC')" >> README.md
          echo "**Activity level:** ${{ env.activity_level }}" >> README.md
          
          echo "docs_updated=true" >> $GITHUB_ENV
          echo "âœ… Documentation updated"
          
      - name: Create Work Log
        if: env.should_run == 'true'
        run: |
          echo "Creating work log..."
          
          cat > work_log.md << EOF
          # Work Log - $(date '+%A, %B %d, %Y')
          
          EOF
          
          if [ "${{ env.day_name }}" = "Saturday" ]; then
            cat >> work_log.md << EOF
          ## Weekend Maintenance
          - Light cleanup and updates
          - Data backup
          - Documentation review
          EOF
          else
            cat >> work_log.md << EOF
          ## Daily Development
          - Processed project data
          - Updated documentation
          - Ran automated tests
          - Maintained code quality
          EOF
          fi
          
          cat >> work_log.md << EOF
          
          *Automated maintenance completed at $(date '+%H:%M UTC')*
          EOF
          
          echo "âœ… Work log created"
          
      - name: Generate Performance Report
        if: env.should_run == 'true'
        run: |
          cat > $GITHUB_STEP_SUMMARY << EOF
          ## Daily Maintenance Report
          **Date:** $(date '+%Y-%m-%d')
          **Day:** ${{ env.day_name }}
          **Activity Level:** ${{ env.activity_level }}
          
          EOF
          
          if [ "${{ env.skip_tests }}" = "true" ]; then
            echo "**Note:** Weekend mode - tests skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Status:** âœ… Completed successfully" >> $GITHUB_STEP_SUMMARY
          
      - name: Upload Test Results
        if: env.should_run == 'true' && env.skip_tests == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ env.day_name }}
          path: test_results/
          retention-days: 3

      - name: Stage Changes
        id: stage-changes
        if: env.should_run == 'true'
        run: |
          git add work_log.md 2>/dev/null || true
          git add daily_update.md 2>/dev/null || true
          git add processed_data.json 2>/dev/null || true
          git add docs/analytics.md 2>/dev/null || true
          git add README.md 2>/dev/null || true
          
          if [ -d "test_results/" ] && [ "${{ env.skip_tests }}" = "false" ]; then
            git add test_results/ 2>/dev/null || true
          fi
          
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_ENV
            echo "No changes to commit"
            
            # Create timestamp file as fallback
            echo "Last touch: $(date)" > timestamp.txt
            git add timestamp.txt
            echo "has_changes=true" >> $GITHUB_ENV
          else
            echo "has_changes=true" >> $GITHUB_ENV
          fi
          
      - name: Commit Updates
        if: env.should_run == 'true' && env.has_changes == 'true'
        run: |
          COMMIT_MSG="${{ env.commit_message }}"
          
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="update: ${{ env.day_name }} maintenance - $(date '+%Y-%m-%d')"
          fi
          
          git commit -m "$COMMIT_MSG" -m "- Updated work log" -m "- Processed daily data" -m "- Maintained project files"
          
      - name: Push Changes
        if: env.should_run == 'true' && env.has_changes == 'true'
        run: |
          git pull origin main --no-rebase || true
          git push origin main || (sleep 2 && git pull origin main --no-rebase && git push origin main)
          
      - name: Cleanup
        if: always()
        run: |
          rm -f timestamp.txt 2>/dev/null || true
          echo "Cleanup completed"