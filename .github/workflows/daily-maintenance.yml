name: Daily Maintenance

on:
  # VARIED schedule - different times on different days
  schedule:
    # Monday, Wednesday, Friday - morning
    - cron: '17 4 * * 1,3,5'  # 4:17 AM UTC Mon/Wed/Fri
    # Tuesday, Thursday - afternoon/evening
    - cron: '42 20 * * 2,4'   # 8:42 PM UTC Tue/Thu
    # Saturday - late morning (optional light activity)
    - cron: '23 11 * * 6'     # 11:23 AM UTC Saturday
    # Sunday - SKIP (humans rest)
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even on weekend?'
        required: false
        default: 'no'
        type: choice
        options:
          - yes
          - no

permissions:
  contents: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # Skip Sundays automatically (unless forced)
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'schedule' && 
       github.event.schedule != '23 11 * * 6' && 
       github.event.schedule != '42 20 * * 2,4' && 
       github.event.schedule != '17 4 * * 1,3,5') ||
      github.event.inputs.force_run == 'yes'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pandas numpy matplotlib
          
      - name: Configure Git with HUMAN identity
        run: |
          # Use YOUR name/email - NOT bot credentials
          git config --global user.name "Kachi"
          git config --global user.email "Kachi.Henry.Leo@gmail.com"
          git config --global pull.rebase false

      - name: Determine Day Type
        id: day_info
        run: |
          DAY=$(date +%A)
          HOUR=$(date +%H)
          echo "day_name=$DAY" >> $GITHUB_OUTPUT
          echo "hour=$HOUR" >> $GITHUB_OUTPUT
          
          # Different activity levels based on day/time
          if [ "$DAY" = "Saturday" ]; then
            echo "activity_level=light" >> $GITHUB_OUTPUT
            echo "skip_tests=true" >> $GITHUB_OUTPUT
          elif [ "$HOUR" -lt 12 ]; then
            echo "activity_level=normal" >> $GITHUB_OUTPUT
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          else
            echo "activity_level=evening" >> $GITHUB_OUTPUT
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Run Automated Tests (Weekdays only)
        id: tests
        if: steps.day_info.outputs.skip_tests == 'false'
        run: |
          echo "Running test suite..."
          python scripts/run_tests.py
          echo "test_exit_code=$?" >> $GITHUB_OUTPUT
          
      - name: Process Data & Generate Analytics
        id: data-process
        run: |
          echo "Processing data..."
          python scripts/process_data.py
          
          # Add day-specific analytics
          DAY="${{ steps.day_info.outputs.day_name }}"
          echo "# $DAY Update - $(date '+%Y-%m-%d')" >> daily_update.md
          echo "" >> daily_update.md
          echo "## Activity Summary" >> daily_update.md
          echo "- Data processed: $(date '+%H:%M')" >> daily_update.md
          echo "- Day type: ${{ steps.day_info.outputs.activity_level }}" >> daily_update.md
          echo "" >> daily_update.md
          
          echo "data_processed=true" >> $GITHUB_OUTPUT
          
      - name: Update Documentation (Human-like)
        id: docs
        run: |
          echo "Updating documentation..."
          
          # Create varied commit messages
          MESSAGES=(
            "docs: Update project files - $(date '+%Y-%m-%d')"
            "chore: Maintenance updates for $(date '+%A')"
            "update: Daily sync and data processing"
            "fix: Minor updates and cleanup"
            "feat: Add daily analytics report"
          )
          
          # Pick random message
          RANDOM_MSG=${MESSAGES[$RANDOM % ${#MESSAGES[@]}]}
          echo "commit_message=$RANDOM_MSG" >> $GITHUB_OUTPUT
          
          # Update docs with day-specific content
          python scripts/update_docs.py
          
          # Add timestamp to README
          echo "" >> README.md
          echo "**Last updated:** $(date '+%A, %B %d, %Y at %H:%M UTC')" >> README.md
          echo "**Activity level:** ${{ steps.day_info.outputs.activity_level }}" >> README.md
          
          echo "docs_updated=true" >> $GITHUB_OUTPUT
          
      - name: Create Human-Like Work Log
        if: always()
        run: |
          # Create a file that looks like human work
          echo "# Work Log - $(date '+%A, %B %d, %Y')" > work_log.md
          echo "" >> work_log.md
          
          if [ "${{ steps.day_info.outputs.day_name }}" = "Saturday" ]; then
            echo "## Weekend Maintenance" >> work_log.md
            echo "- Light cleanup and updates" >> work_log.md
            echo "- Data backup" >> work_log.md
            echo "- Documentation review" >> work_log.md
          else
            echo "## Daily Development" >> work_log.md
            echo "- Processed project data" >> work_log.md
            echo "- Updated documentation" >> work_log.md
            echo "- Ran automated tests" >> work_log.md
            echo "- Maintained code quality" >> work_log.md
          fi
          
          echo "" >> work_log.md
          echo "*Automated maintenance completed at $(date '+%H:%M UTC')*" >> work_log.md
          
      - name: Generate Performance Report
        if: always()
        run: |
          echo "## Daily Maintenance Report" > $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** ${{ steps.day_info.outputs.day_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Activity Level:** ${{ steps.day_info.outputs.activity_level }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.day_info.outputs.skip_tests }}" = "true" ]; then
            echo "**Note:** Weekend mode - tests skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Upload Test Results
        if: steps.day_info.outputs.skip_tests == 'false' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ steps.day_info.outputs.day_name }}
          path: test_results/
          retention-days: 3

      - name: Stage Changes for Commit
        id: stage-changes
        run: |
          # Always commit these human-looking files
          git add work_log.md
          git add daily_update.md
          
          # Only add other files if they exist and have changes
          if [ -f "docs/analytics.md" ]; then
            git add docs/analytics.md 2>/dev/null || true
          fi
          
          if [ -d "test_results/" ] && [ "${{ steps.day_info.outputs.skip_tests }}" = "false" ]; then
            git add test_results/ 2>/dev/null || true
          fi
          
          # Update README
          git add README.md 2>/dev/null || true
          
          # Check if we have anything to commit
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit (unusual - creating minimal update)"
            
            # Fallback: create timestamp file
            echo "Last touch: $(date)" > timestamp.txt
            git add timestamp.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit Human-Like Updates
        if: steps.stage-changes.outputs.has_changes == 'true'
        run: |
          # Use the random message OR create day-specific one
          if [ -n "${{ steps.docs.outputs.commit_message }}" ]; then
            COMMIT_MSG="${{ steps.docs.outputs.commit_message }}"
          else
            DAY="${{ steps.day_info.outputs.day_name }}"
            COMMIT_MSG="update: $DAY maintenance - $(date '+%Y-%m-%d')"
          fi
          
          # Add body to commit message
          COMMIT_MSG="$COMMIT_MSG
          
          - Updated work log
          - Processed daily data
          - Maintained project files"
          
          if [ "${{ steps.day_info.outputs.skip_tests }}" = "false" ]; then
            COMMIT_MSG="$COMMIT_MSG
          - Ran test suite"
          fi
          
          git commit -m "$COMMIT_MSG"
          
      - name: Push Changes
        if: steps.stage-changes.outputs.has_changes == 'true'
        run: |
          # Pull latest first
          git pull origin main --no-rebase || echo "Pull failed, continuing..."
          
          # Push with retry logic
          MAX_RETRIES=3
          COUNT=0
          while [ $COUNT -lt $MAX_RETRIES ]; do
            git push origin main && break
            COUNT=$((COUNT+1))
            echo "Push failed, retrying... ($COUNT/$MAX_RETRIES)"
            sleep 2
          done
          
      - name: Cleanup Temporary Files
        if: always()
        run: |
          rm -f timestamp.txt 2>/dev/null || true
          echo "Cleanup completed"
