name: Daily Contribution Automation

on:
  schedule:
    # Multiple random times to appear natural (6 times daily)
    - cron: '7 2 * * *'    # 2:07 AM UTC
    - cron: '33 8 * * *'   # 8:33 AM UTC
    - cron: '19 14 * * *'  # 2:19 PM UTC
    - cron: '51 17 * * *'  # 5:51 PM UTC
    - cron: '24 21 * * *'  # 9:24 PM UTC
    - cron: '48 23 * * *'  # 11:48 PM UTC
    
  workflow_dispatch:       # Manual trigger
  push:                   # Run when code is pushed (for testing)

# Set workflow permissions explicitly
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  automated-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}
          
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: ðŸ“Š Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
      - name: ðŸ”„ Pull latest changes
        run: |
          git fetch origin
          git pull origin $(git branch --show-current) || echo "No existing branch to pull"
          
      - name: ðŸš€ Run Daily Automation
        id: automation
        run: |
          echo "Starting automation at $(date)"
          python daily_commit.py
          
      - name: ðŸ“ˆ Generate Contribution Report
        if: always()
        run: |
          echo "### ðŸŽ¯ Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** $(git branch --show-current)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ›¡ï¸ Safety Check (Avoid Empty Commits)
        run: |
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit. Creating minimal update..."
            echo "# Update $(date)" >> placeholder.md
            git add placeholder.md
            git commit -m "Maintenance: Repository heartbeat - $(date +'%Y-%m-%d')" || echo "No new changes"
          fi
          
      - name: ðŸ§¹ Cleanup (Optional)
        if: always()
        run: |
          rm -f placeholder.md 2>/dev/null || true

  # Additional job for analytics (optional)
  analytics:
    runs-on: ubuntu-latest
    needs: automated-commit
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Analytics
        run: |
          echo "## ðŸ“ˆ Contribution Analytics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Run:** Scheduled for random times throughout the day" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time Variability:** Multiple cron schedules for natural appearance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files Managed:**" >> $GITHUB_STEP_SUMMARY
          echo "- contributions_log.json" >> $GITHUB_STEP_SUMMARY
          echo "- README.md" >> $GITHUB_STEP_SUMMARY
          echo "- contributions_stats.md" >> $GITHUB_STEP_SUMMARY
          echo "- Various config/data files" >> $GITHUB_STEP_SUMMARY
